<html>
    <head>
        <meta charset='utf-8'>
        <title>ESP Inverter - Dashboard v0.1</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!--
            ------------------------------------------------------------------------------
            ---- BEGIN:  
            ---- JS and CSS for Panels
            ------------------------------------------------------------------------------
        -->
        <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css' rel='stylesheet'>
        <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
        <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js'></script>
        <script type='text/javascript' src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js'></script>
        <link href='' rel='stylesheet'>
        <style>.panel.with-nav-tabs .panel-heading {
                    padding: 5px 5px 0 5px;
                    }

                    .panel.with-nav-tabs .nav-tabs {
                    border-bottom: none;
                    }

                    .panel.with-nav-tabs .nav-justified {
                    margin-bottom: -1px;
                    }

                    /********************************************************************/
                    /*** PANEL PRIMARY ***/
                    .with-nav-tabs.panel-primary .nav-tabs>li>a,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:focus {
                        color: #fff;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>.open>a,
                    .with-nav-tabs.panel-primary .nav-tabs>.open>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>.open>a:focus,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:focus {
                        color: #fff;
                        background-color: #3071a9;
                        border-color: transparent;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.active>a,
                    .with-nav-tabs.panel-primary .nav-tabs>li.active>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li.active>a:focus {
                        color: #428bca;
                        background-color: #fff;
                        border-color: #428bca;
                        border-bottom-color: transparent;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu {
                        background-color: #428bca;
                        border-color: #3071a9;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>li>a {
                        color: #fff;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>li>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>li>a:focus {
                        background-color: #3071a9;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>.active>a,
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>.active>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>.active>a:focus {
                        background-color: #4a9fe9;
                    }
        </style>        

        <!--
            ------------------------------------------------------------------------------
            ---- END:  
            ---- JS and CSS for Panels
            ------------------------------------------------------------------------------
        -->

        <style>
            h2 {
              font-family: Arial;
              font-size: 2.5rem;
              text-align: center;
            }
          </style>

    </Head>
    <body>
        <table style="width: 100%"> 
            <tr>
                <td style="width: 20px">
                    &nbsp;
                </td>
                <td style="width: 120px">
                    <img id="battery" src="battery-on.png"><label id="battery_text"></label>
                </td>
                <td style="width: 120px">
                    <img id="energy1" src="sun-off.png">
                    <img id="energy2" src="plug-off.png">
                </td>
                <td style="width: auto">
                    <h2>ESP Inverter Readings</h2>
                </td>
                <td style="width: 100px; text-align: center;">220v</td>
                <td style="width: 60px">
                    <img id="electric-pole" style="background-color: lightgreen; size-adjust: 50px;" src="electric-pole.png">
                </td>
                <td style="width: 20px">
                    &nbsp;
                </td>
        </tr>
        </table>

        <div class="col-md-12">
            <div class="panel with-nav-tabs panel-primary">
                <div class="panel-heading">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#tab1primary" data-toggle="tab">LIVE Readings</a></li>
                        <li><a href="#tab2primary" data-toggle="tab">Daily Readings</a></li>
                        <li><a href="#tab3primary" data-toggle="tab">Primary 3</a></li>
                        <li class="dropdown">
                            <a href="#" data-toggle="dropdown">Dropdown <span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#tab4primary" data-toggle="tab">Primary 4</a></li>
                                <li><a href="#tab5primary" data-toggle="tab">Primary 5</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="panel-body">
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="tab1primary">
                            <div id="chart-PVPower" class="container"></div>
                            <div id="chart-ActivePower" class="container"></div>
                            <div id="chart-BatVoltage" class="container"></div>
                            <div id="chart-BatCharge" class="container"></div>
                            <div id="chart-BatDischarge" class="container"></div>
                        </div>
                        <div class="tab-pane fade" id="tab2primary">
                            <form id="day_select" name='params' method='POST' action='query_daily_db'>
                                Choose a date (UNIX timestamp): 
                                <input type=text style='font-size: large' value='' id='daily_date' name='daily_date'/>
                                <input type=submit style='font-size: large' value='Query database'/>
                            </form>
                            <div id="chart-BatVoltage_DAY" class="container"></div>
                        </div>
                        <div class="tab-pane fade" id="tab3primary">Primary 3</div>
                        <div class="tab-pane fade" id="tab4primary">Primary 4</div>
                        <div class="tab-pane fade" id="tab5primary">Primary 5</div>
                    </div>
                </div>
            </div>
        </div>


        
    </body>

    <!--
        ------------------------------------------------------------------------------
        ---- START:  
        ---- JS for HIGHCHARTS -> Must be after DIVs
        ------------------------------------------------------------------------------
    -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>


        /////////////////////////////////////////////////////////////////////
        ///// BATTERY STATUS /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////

        var interval = setInterval(function () {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var receivedString = this.responseText;
                    document.getElementById("battery_text").innerHTML = this.responseText + " V";
            }
        };
        xhttp.open("GET", "/battery_volts", true);
        xhttp.send();
        }, 2000);


        /////////////////////////////////////////////////////////////////////
        ///// CHARGING STATUS /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////

        var interval = setInterval(function () {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var receivedString = this.responseText;
                if (receivedString == "sun_plug") {
                    document.getElementById("energy1").setAttribute("src", "sun-on.png");  
                    document.getElementById("energy2").setAttribute("src", "plug-on.png");  
                }
                if (receivedString == "sun") {
                    document.getElementById("energy1").setAttribute("src", "sun-on.png");
                    document.getElementById("energy2").setAttribute("src", "plug-off.png");  
                }
                if (receivedString == "plug") {
                    document.getElementById("energy1").setAttribute("src", "plug-on.png");
                    document.getElementById("energy2").setAttribute("src", "sun-off.png");  
                }
                if (receivedString == "off") {
                    document.getElementById("energy1").setAttribute("src", "plug-off.png");
                    document.getElementById("energy2").setAttribute("src", "sun-off.png");  
                }
            }
        };
        xhttp.open("GET", "/charger_status", true);
        xhttp.send();
        }, 2000);


        /////////////////////////////////////////////////////////////////////
        ///// chart-PVPower /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////
        var chartT = new Highcharts.Chart({
        chart:{ renderTo : 'chart-PVPower' },
        title: { text: 'Generated Solar Power' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: true,
            dataLabels: { enabled: true }
            },
            series: { color: '#059e8a', lineWidth: 3 } 
        },
        xAxis: { type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Watts (W)' }
        },
        credits: { enabled: false }
        });

        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartT.series[0].data.length > 96) {
                chartT.series[0].addPoint([x, y], true, true, true);
            } else {
                chartT.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/PVPower", true);
        xhttp.send();
        }, 2000 ) ;

        /////////////////////////////////////////////////////////////////////
        ///// chart-ActivePower /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////

        var chartH = new Highcharts.Chart({
        chart:{ renderTo:'chart-ActivePower' },
        title: { text: 'Active Power Consumption' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            }
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Load (Watts)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartH.series[0].data.length > 96) {
                chartH.series[0].addPoint([x, y], true, true, true);
            } else {
                chartH.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/ActivePower", true);
        xhttp.send();
        }, 2000 ) ;

        /////////////////////////////////////////////////////////////////////
        ///// chart-BatVoltage /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////
        var chartP = new Highcharts.Chart({
        chart:{ renderTo:'chart-BatVoltage' },
        title: { text: 'Battery Bank Voltage' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            },
            series: { color: '#18009c', lineWidth: 3}
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Voltage (V)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartP.series[0].data.length > 96) {
                chartP.series[0].addPoint([x, y], true, true, true);
            } else {
                chartP.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/BatVoltage", true);
        xhttp.send();
        }, 2000 ) ;


        /////////////////////////////////////////////////////////////////////
        ///// chart-BatVoltage /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////

        let chart; // global

        // Create the chart
        window.addEventListener('load', async function () {


            // Access the form element...
            const form = document.getElementById( "day_select" );

            // ...and take over its submit event.
            form.addEventListener( "submit", async function ( event ) {
                event.preventDefault();

                var myHeaders = new Headers();
                myHeaders.append('pragma', 'no-cache');
                myHeaders.append('cache-control', 'no-cache');

                var myInit = 
                {
                    method: 'GET',
                    headers: myHeaders,
                };

                const result = await fetch('http://192.168.0.122/sqlDaily.json?daily_date=' + document.getElementById("daily_date").value, myInit);
                if (result.ok) jdata_battery = await result.json();
                chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'chart-BatVoltage_DAY'
                    },
                    title: {
                        text: 'Battery Volts by day'
                    },
                    plotOptions: {
                        line: 
                        { 
                            animation: false,
                            dataLabels: 
                            { 
                                enabled: false,
                                style: 
                                {
                                    fontWeight: 'normal',
                                } 
                            }
                        },
                        series: { color: '#059e8a', lineWidth: 2 } 
                    },
                    xAxis: 
                    {
                        type: 'datetime',
                        dateTimeLabelFormats: { second: '%H:%M:%S' }
                    },
                    yAxis: 
                    {
                        title: {
                            text: 'Volts',
                            margin: 10
                        }
                    },
                    series: [{
                        type: 'line',
                        name: 'Battery Volts',
                        data: jdata_battery
                    }]
                } );
            } );
        });

        /////////////////////////////////////////////////////////////////////
        ///// chart-BatCharge /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////
        var chartX = new Highcharts.Chart({
        chart:{ renderTo:'chart-BatCharge' },
        title: { text: 'Battery Charging Current' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            },
            series: { color: '#18009c', lineWidth: 3 }
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Current (A)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartX.series[0].data.length > 96) {
                chartX.series[0].addPoint([x, y], true, true, true);
            } else {
                chartX.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/BatCharge", true);
        xhttp.send();
        }, 2000 ) ;

        ///
        // chart-BatDischarge

        var chartY = new Highcharts.Chart({
        chart:{ renderTo:'chart-BatDischarge' },
        title: { text: 'Battery Discharge Current' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            },
            series: { color: '#18009c', lineWidth: 3 }
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Current (A)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartY.series[0].data.length > 96) {
                chartY.series[0].addPoint([x, y], true, true, true);
            } else {
                chartY.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/BatDischarge", true);
        xhttp.send();
        }, 2000 ) ;

     </script>
</html>