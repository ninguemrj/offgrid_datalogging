<html>
    <head>
        <meta charset='utf-8'>
        <title>ESP Inverter - Dashboard v0.1</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!--
            ------------------------------------------------------------------------------
            ---- BEGIN:  
            ---- JS and CSS for Panels
            ------------------------------------------------------------------------------
        -->
        <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css' rel='stylesheet'>
        <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
        <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js'></script>
        <script type='text/javascript' src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js'></script>
        <link href='' rel='stylesheet'>
        <style>.panel.with-nav-tabs .panel-heading {
                    padding: 5px 5px 0 5px;
                    }

                    .panel.with-nav-tabs .nav-tabs {
                    border-bottom: none;
                    }

                    .panel.with-nav-tabs .nav-justified {
                    margin-bottom: -1px;
                    }

                    /********************************************************************/
                    /*** PANEL PRIMARY ***/
                    .with-nav-tabs.panel-primary .nav-tabs>li>a,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:focus {
                        color: #fff;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>.open>a,
                    .with-nav-tabs.panel-primary .nav-tabs>.open>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>.open>a:focus,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li>a:focus {
                        color: #fff;
                        background-color: #3071a9;
                        border-color: transparent;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.active>a,
                    .with-nav-tabs.panel-primary .nav-tabs>li.active>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li.active>a:focus {
                        color: #428bca;
                        background-color: #fff;
                        border-color: #428bca;
                        border-bottom-color: transparent;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu {
                        background-color: #428bca;
                        border-color: #3071a9;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>li>a {
                        color: #fff;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>li>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>li>a:focus {
                        background-color: #3071a9;
                    }
                    
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>.active>a,
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>.active>a:hover,
                    .with-nav-tabs.panel-primary .nav-tabs>li.dropdown .dropdown-menu>.active>a:focus {
                        background-color: #4a9fe9;
                    }
        </style>        

        <!--
            ------------------------------------------------------------------------------
            ---- END:  
            ---- JS and CSS for Panels
            ------------------------------------------------------------------------------
        -->

        <style>
            h2 {
              font-family: Arial;
              font-size: 2.5rem;
              text-align: center;
            }
          </style>

    </Head>
    <body>
        <table style="width: 100%"> 
            <tr>
                <td style="width: 20px">
                    &nbsp;
                </td>
                <td style="width: 120px">
                    <img id="battery" src="battery-on.png"><label id="battery_text"></label>
                </td>
                <td style="width: 120px">
                    <img id="energy1" src="sun-off.png">
                    <img id="energy2" src="plug-off.png">
                </td>
                <td style="width: auto">
                    <h2>ESP Inverter Readings</h2>
                </td>
                <td style="width: 100px; text-align: center;">220v</td>
                <td style="width: 60px">
                    <img id="electric-pole" style="background-color: lightgreen; size-adjust: 50px;" src="electric-pole.png">
                </td>
                <td style="width: 20px">
                    &nbsp;
                </td>
        </tr>
        </table>

        <div class="col-md-12">
            <div class="panel with-nav-tabs panel-primary">
                <div class="panel-heading">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#tab1primary" data-toggle="tab">LIVE Readings</a></li>
                        <li><a href="#tab2primary" data-toggle="tab">Daily Readings</a></li>
                        <li><a href="#tab3primary" data-toggle="tab">Primary 3</a></li>
                        <li class="dropdown">
                            <a href="#" data-toggle="dropdown">Dropdown <span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#tab4primary" data-toggle="tab">Primary 4</a></li>
                                <li><a href="#tab5primary" data-toggle="tab">Primary 5</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="panel-body">
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="tab1primary">
                            <div id="chart-PVPower" class="container"></div>
                            <div id="chart-ActivePower" class="container"></div>
                            <div id="chart-BatVoltage" class="container"></div>
                            <div id="chart-BatCharge" class="container"></div>
                            <div id="chart-BatDischarge" class="container"></div>
                        </div>
                        <div class="tab-pane fade" id="tab2primary">
                            <form id="day_select" name='params' method='POST' action='query_daily_db'>
                                Pick a date: 
                                <input type=date style='font-size: large' value='' id='daily_date' name='daily_date'/>
                                <input type=submit style='font-size: large' value='Update chart'/>
                            </form>
                            <div id="chart-PVPower_DAY" class="container"></div>
                            <div id="chart-ActivePower_DAY" class="container"></div>
                            <div id="chart-BatVoltage_DAY" class="container"></div>
                            <div id="chart-BatCharge_DAY" class="container"></div>
                            <div id="chart-BatDischarge_DAY" class="container"></div>
                        </div>
                        <div class="tab-pane fade" id="tab3primary">Primary 3</div>
                        <div class="tab-pane fade" id="tab4primary">Primary 4</div>
                        <div class="tab-pane fade" id="tab5primary">Primary 5</div>
                    </div>
                </div>
            </div>
        </div>


        
    </body>

    <!--
        ------------------------------------------------------------------------------
        ---- START:  
        ---- JS for HIGHCHARTS -> Must be after DIVs
        ------------------------------------------------------------------------------
    -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>

    //--- BEGIN: GENERAL FUNCTIONS AND GLOBAL VARIABLES --------------------------
        function delay(time) {
            return new Promise(resolve => setTimeout(resolve, time));
        }

        let bat_daily_chart; // global
        let _min_volts; // stores the minimum voltage (CUTOFF) set in inverter for limiting battery voltage chart scales
        let _bulk_volts; // stores the bulk charge voltage set in inverter
        let _float_volts; // stores the minimumfloat charge voltage set in inverter 
        let _back_to_grid_volts; // stores the back to grid voltage set in inverter

        // HEADERS PREPARATION FOR ALL FETCH FUNCTIONS
        var myHeaders = new Headers();
        myHeaders.append('pragma', 'no-cache');
        myHeaders.append('cache-control', 'no-cache');
        var myInit = 
        {
            method: 'GET',
            headers: myHeaders,
        };
    //--- END: GENERAL FUNCTIONS AND GLOBAL VARIABLES --------------------------


    //--- BEGIN: RUNS AFTER LOADING HTML BUT BEFORE CSS AND IMAGES ---------------------------
        window.addEventListener('DOMContentLoaded', async function () {
            const QPIRI_result = await fetch('./QPIRI.json', myInit);
            if (QPIRI_result.ok) 
            {
                QPIRI_array = await QPIRI_result.json();
                _min_volts = QPIRI_array[0];
                _bulk_volts = QPIRI_array[1];
                _float_volts = QPIRI_array[2];
                _back_to_grid_volts = QPIRI_array[3];
            }

        });
    //--- END: RUNS AFTER LOADING HTML BUT BEFORE CSS AND IMAGES ---------------------------



        /////////////////////////////////////////////////////////////////////
        ///// BATTERY STATUS /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////

        var interval = setInterval(function () {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var receivedString = this.responseText;
                    document.getElementById("battery_text").innerHTML = this.responseText + " V";
            }
        };
        xhttp.open("GET", "/battery_volts", true);
        xhttp.send();
        }, 2000);


        /////////////////////////////////////////////////////////////////////
        ///// CHARGING STATUS /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////

        var interval = setInterval(function () {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var receivedString = this.responseText;
                if (receivedString == "sun_plug") {
                    document.getElementById("energy1").setAttribute("src", "sun-on.png");  
                    document.getElementById("energy2").setAttribute("src", "plug-on.png");  
                }
                if (receivedString == "sun") {
                    document.getElementById("energy1").setAttribute("src", "sun-on.png");
                    document.getElementById("energy2").setAttribute("src", "plug-off.png");  
                }
                if (receivedString == "plug") {
                    document.getElementById("energy1").setAttribute("src", "plug-on.png");
                    document.getElementById("energy2").setAttribute("src", "sun-off.png");  
                }
                if (receivedString == "off") {
                    document.getElementById("energy1").setAttribute("src", "plug-off.png");
                    document.getElementById("energy2").setAttribute("src", "sun-off.png");  
                }
            }
        };
        xhttp.open("GET", "/charger_status", true);
        xhttp.send();
        }, 30000);


        /////////////////////////////////////////////////////////////////////
        ///// chart-PVPower /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////
        var chartT = new Highcharts.Chart({
        chart:{ renderTo : 'chart-PVPower' },
        title: { text: 'Generated Solar Power' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: true,
            dataLabels: { enabled: true }
            },
            series: { color: '#059e8a', lineWidth: 3 } 
        },
        xAxis: { type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Watts (W)' }
        },
        credits: { enabled: false }
        });

        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartT.series[0].data.length > 96) {
                chartT.series[0].addPoint([x, y], true, true, true);
            } else {
                chartT.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/PVPower", true);
        xhttp.send();
        }, 2000 ) ;

        /////////////////////////////////////////////////////////////////////
        ///// chart-ActivePower /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////

        var chartH = new Highcharts.Chart({
        chart:{ renderTo:'chart-ActivePower' },
        title: { text: 'Active Power Consumption' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            }
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Load (Watts)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartH.series[0].data.length > 96) {
                chartH.series[0].addPoint([x, y], true, true, true);
            } else {
                chartH.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/ActivePower", true);
        xhttp.send();
        }, 2000 ) ;

        /////////////////////////////////////////////////////////////////////
        ///// chart-BatVoltage /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////
        var chartP = new Highcharts.Chart({
        chart:{ renderTo:'chart-BatVoltage' },
        title: { text: 'Battery Bank Voltage' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            },
            series: { color: '#18009c', lineWidth: 3}
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            min: _min_volts,     /// Minimal battery voltage on chart (CUT-OFF), to avoid missing readings change the minimum Y scale to zero
            title: { text: 'Voltage (V)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartP.series[0].data.length > 96) {
                chartP.series[0].addPoint([x, y], true, true, true);
            } else {
                chartP.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/BatVoltage", true);
        xhttp.send();
        }, 2000 ) ;


        /////////////////////////////////////////////////////////////////////
        ///// chart-BatVoltage /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////



        // RUNS AFTER LOADING HTML, CSS AND IMAGES
        window.addEventListener('load', async function () {


//--- BEGIN: UPDATES DAILY CHARTS -------------------------------------------------------------------------            

        //--- STEP #1: Capture form button click
            const form = document.getElementById( "day_select" );
            form.addEventListener( "submit", async function ( event ) {
                event.preventDefault();     // DO NOT PERMIT PAGE LOAD ON BUTTON CLICK
                const date = new Date(document.getElementById("daily_date").value);
                const choosen_date = date.getTime() / 1000; //millis to seconds                
                
        //--- STEP #2: Send new date to ESP32
                const result = await fetch('http://192.168.0.122/sqlDaily.json?daily_date=' + choosen_date, myInit);
                if (result.ok) feedback = await result.json();

        //--- STEP #3: WAITS ESP32 to prepare JSON data (hold on while "Updating")
                while (feedback[0][0] == "Updating...")
                {
                    await delay(1000);
                    const result = await fetch('http://192.168.0.122/sqlDaily.json', myInit);
                    if (result.ok) feedback = await result.json();
                }

                var feedback_PV      = feedback[0].map((e,i) => [e,feedback[1][i]]);
                var feedback_ACPower = feedback[0].map((e,i) => [e,feedback[2][i]]);
                var feedback_batVolt = feedback[0].map((e,i) => [e,feedback[3][i]]);
                var feedback_batChar = feedback[0].map((e,i) => [e,feedback[4][i]]);
                var feedback_batDisC = feedback[0].map((e,i) => [e,feedback[5][i]]);

        //--- STEP #4.1: BAT VOLTS: Update CHART with new data from ESP32                
                bat_daily_chart = new Highcharts.Chart({
                    chart: { renderTo: 'chart-BatVoltage_DAY' },
                    title: { text: 'Battery Volts: Day view' },
                    plotOptions: {
                        line: { animation: false, dataLabels: { enabled: false, style: { fontWeight: 'normal' }}},
                        series: { color: '#059e8a', lineWidth: 2 } 
                    },
                    xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
                    yAxis: {
                        min: _min_volts,     /// Minimal battery voltage on chart (CUT-OFF), to avoid missing readings change the minimum Y scale to zero
                        title: { text: 'Volts', margin: 10 }
                    },
                    series: [{ type: 'line', name: 'Battery Volts',
                        data: feedback_batVolt
                    }]
                } );

                //--- STEP #4.2: PV Power: Update CHART with new data from ESP32                
                PV_daily_chart = new Highcharts.Chart({
                    chart: { renderTo: 'chart-PVPower_DAY' },
                    title: { text: 'Generated Solar Power: Day view ' },
                    plotOptions: {
                        line: { animation: false, dataLabels: { enabled: false, style: { fontWeight: 'normal' }}},
                        series: { color: '#059e8a', lineWidth: 2 } 
                    },
                    xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
                    yAxis: {
                        title: { text: 'Watts', margin: 10 }
                    },
                    series: [{ type: 'line', name: 'Watts',
                        data: feedback_PV 
                    }]
                } );

                //--- STEP #4.3: AC Power: Update CHART with new data from ESP32                
                ACPower_daily_chart = new Highcharts.Chart({
                    chart: { renderTo: 'chart-ActivePower_DAY' },
                    title: { text: 'Active Power Consumption: Day view' },
                    plotOptions: {
                        line: { animation: false, dataLabels: { enabled: false, style: { fontWeight: 'normal' }}},
                        series: { color: '#059e8a', lineWidth: 2 } 
                    },
                    xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
                    yAxis: {
                        title: { text: 'Watts', margin: 10 }
                    },
                    series: [{ type: 'line', name: 'Watts',
                        data: feedback_ACPower 
                    }]
                } );

                //--- STEP #4.4: Bat Charge: Update CHART with new data from ESP32                
                bat_charg_daily_chart = new Highcharts.Chart({
                    chart: { renderTo: 'chart-BatCharge_DAY' },
                    title: { text: 'Battery Charging Current: Day view' },
                    plotOptions: {
                        line: { animation: false, dataLabels: { enabled: false, style: { fontWeight: 'normal' }}},
                        series: { color: '#059e8a', lineWidth: 2 } 
                    },
                    xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
                    yAxis: {
                        title: { text: 'Ampers', margin: 10 }
                    },
                    series: [{ type: 'line', name: 'Ampers',
                        data: feedback_batChar 
                    }]
                } );


                //--- STEP #4.5: Bat disCharge: Update CHART with new data from ESP32                
                bat_discharg_daily_chart = new Highcharts.Chart({
                    chart: { renderTo: 'chart-BatDischarge_DAY' },
                    title: { text: 'Battery Discharge Current: Day view' },
                    plotOptions: {
                        line: { animation: false, dataLabels: { enabled: false, style: { fontWeight: 'normal' }}},
                        series: { color: '#059e8a', lineWidth: 2 } 
                    },
                    xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' } },
                    yAxis: {
                        title: { text: 'Ampers', margin: 10 }
                    },
                    series: [{ type: 'line', name: 'Ampers',
                        data: feedback_batDisC
                    }]
                } );


            } );
        });


//--- END: UPDATES DAILY CHARTS -------------------------------------------------------------------------            


        /////////////////////////////////////////////////////////////////////
        ///// chart-BatCharge /////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////
        var chartX = new Highcharts.Chart({
        chart:{ renderTo:'chart-BatCharge' },
        title: { text: 'Battery Charging Current' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            },
            series: { color: '#18009c', lineWidth: 3 }
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Current (A)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartX.series[0].data.length > 96) {
                chartX.series[0].addPoint([x, y], true, true, true);
            } else {
                chartX.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/BatCharge", true);
        xhttp.send();
        }, 2000 ) ;

        ///
        // chart-BatDischarge

        var chartY = new Highcharts.Chart({
        chart:{ renderTo:'chart-BatDischarge' },
        title: { text: 'Battery Discharge Current' },
        series: [{
            showInLegend: false,
            data: []
        }],
        plotOptions: {
            line: { animation: false,
            dataLabels: { enabled: true }
            },
            series: { color: '#18009c', lineWidth: 3 }
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { second: '%H:%M:%S' }
        },
        yAxis: {
            title: { text: 'Current (A)' }
        },
        credits: { enabled: false }
        });
        setInterval(function ( ) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
            var x = (new Date()).getTime(),
                y = parseFloat(this.responseText);
            //console.log(this.responseText);
            if(chartY.series[0].data.length > 96) {
                chartY.series[0].addPoint([x, y], true, true, true);
            } else {
                chartY.series[0].addPoint([x, y], true, false, true);
            }
            }
        };
        xhttp.open("GET", "/BatDischarge", true);
        xhttp.send();
        }, 2000 ) ;

     </script>
</html>